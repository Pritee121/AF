{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Service</title>

    <!-- ✅ Stylesheets -->
    <link rel="stylesheet" href="{% static 'css/add_service2.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- ✅ Flatpickr for Date & Time Pickers -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <h1 class="text-center">Add a New Service</h1>

    <div class="container">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <h3>Service Details</h3>
            {{ service_form.as_p }}

            <h3>Availability Slots</h3>
            <div id="availability-formset">
                {{ formset.management_form }}
                {% for form in formset %}
                    <div class="availability-entry">
                        <label>Date:</label>
                        {{ form.available_date }}
                        <label>Time:</label>
                        {{ form.available_time }}
                        <button type="button" class="remove-slot">❌ Remove</button>
                    </div>
                {% endfor %}
            </div>

            <!-- ✅ Add More Slots Button -->
            <button type="button" id="add-slot" class="add-btn">➕ Add More Slots</button>

            <button type="submit" class="submit-btn">Submit Service</button>
        </form>

        <!-- ✅ Back to Services Button -->
        <div class="text-center">
            <a href="{% url 'services' %}" class="back-btn">⬅ Back to Services</a>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            flatpickr(".datepicker", { dateFormat: "Y-m-d" });
            flatpickr(".timepicker", { enableTime: true, noCalendar: true, dateFormat: "H:i" });
        });

        $(document).ready(function () {
            let formsetDiv = $("#availability-formset");
            let totalForms = $("#id_availability-TOTAL_FORMS");  // ✅ Corrected ID
            let formNum = parseInt(totalForms.val());

            // ✅ Add new slot dynamically
            $("#add-slot").click(function () {
                let newForm = $(".availability-entry:first").clone();
                
                // ✅ Clear input values
                newForm.find("input").each(function () {
                    let name = $(this).attr("name").replace(/-\d+-/, `-${formNum}-`);
                    let id = $(this).attr("id").replace(/-\d+-/, `-${formNum}-`);
                    $(this).attr({ name: name, id: id }).val("");
                });

                // ✅ Append the new form
                formsetDiv.append(newForm);
                totalForms.val(formNum + 1);

                // ✅ Reinitialize Flatpickr for new fields
                newForm.find(".datepicker").flatpickr({ dateFormat: "Y-m-d" });
                newForm.find(".timepicker").flatpickr({ enableTime: true, noCalendar: true, dateFormat: "H:i" });

                formNum++;
            });

            // ✅ Remove slot dynamically
            $(document).on("click", ".remove-slot", function () {
                if ($(".availability-entry").length > 1) {  // Prevent removing all slots
                    $(this).closest(".availability-entry").remove();
                    formNum--;
                    totalForms.val(formNum);
                } else {
                    alert("You must have at least one availability slot.");
                }
            });
        });
    </script>
    
</body>
</html>
