{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Booking History</title>
    <link rel="stylesheet" href="{% static 'css/booking_history.css' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <!-- ✅ Header Section -->
    <header class="header">
        <div class="logo">
            <img src="{% static 'images/logo.png' %}" alt="Artist Finder Logo">
        </div>
        <nav class="navbar">
            <a href="{% url 'home' %}" class="nav-link">Home</a>
            <a href="{% url 'booking_history' %}" class="nav-link active">My Bookings</a>
            <a href="{% url 'aboutus' %}" class="nav-link">About Us</a>
            <a href="{% url 'contactus' %}" class="nav-link">Contact Us</a>
            <a href="{% url 'artist_list' %}" class="nav-link">View Artists</a>

            <!-- ✅ Show Chat Option for Each Artist -->
            {% for artist in artists %}
                <a href="{% url 'user_chat' artist.id %}" class="nav-item">Chat with {{ artist.first_name }}</a>
            {% endfor %}

            <a href="{% url 'login' %}" class="nav-link">🔑 Logout</a>

            <div class="user-profile">
                <a href="{% url 'user_profile' %}">
                    <img src="{% static 'images/mi.jpg' %}" alt="User Profile" class="user-image">
                </a>
            </div>
        </nav>
    </header>

    <!-- ✅ Booking History Section -->
    <div class="booking-history-container">
        <h2>📅 My Booking History</h2>

        <!-- ✅ Booking Table -->
        {% if user_bookings %}
        <table>
            <thead>
                <tr>
                    <th>🎭 Artist</th>
                    <th>🛠 Service</th>
                    <th>📆 Date</th>
                    <th>⏰ Time</th>
                    <th>⌛ Duration</th>
                    <th>💳 Payment</th>
                    <th>💰 Price</th>
                   
                    <th>📌 Status</th>
                    <th>❌ Cancel</th>
                    <th>💰 Payment Status</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in user_bookings %}
                <tr>
                    <td>{{ booking.artist.first_name }} {{ booking.artist.last_name }}</td>
                    <td>{{ booking.service.service_name }}</td>
                    <td>{{ booking.date }}</td>
                    <td>{{ booking.time }}</td>
                    <td>{{ booking.service.duration }}</td>
                    <td>{{ booking.payment_method|title }}</td>
                    <td>Rs. {{ booking.service.price }}</td>
                    <td id="status-{{ booking.id }}">{{ booking.status }}</td>

                    <!-- ✅ Cancel Booking Button for "Pending" or "Confirmed" Status -->
                    <td>
                        {% if booking.status == "Pending" or booking.status == "Confirmed" %}
                            <form id="cancel-booking-{{ booking.id }}" action="{% url 'cancel_booking' booking.id %}" method="POST">
                                {% csrf_token %}
                                <button type="button" class="cancel-btn" onclick="confirmCancel('{{ booking.id }}')">❌ Cancel</button>
                            </form>
                        {% else %}
                            <span class="cancelled-text">N/A</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="no-bookings">🙁 No bookings found.</p>
        {% endif %}
    </div>

    <!-- ✅ SweetAlert2 Script for Confirmation -->
    <script>
        function confirmCancel(bookingId) {
            Swal.fire({
                title: "Cancel Booking?",
                text: "Are you sure you want to cancel this booking?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#D8648C",
                cancelButtonColor: "#6c757d",
                confirmButtonText: "Yes, cancel it!",
                cancelButtonText: "No, keep it"
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById(`cancel-booking-${bookingId}`).submit();
                }
            });
        }function handleCODBooking(userId, serviceId) {
    fetch("/cod_booking/", {
        method: "POST",
        body: JSON.stringify({
            user_id: userId,
            service_id: serviceId
        }),
        headers: { "Content-Type": "application/json" }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Booking successful! Payment is pending.");
            window.location.href = "/dashboard";  // ✅ Redirect to Dashboard
        } else {
            alert("Booking failed! Please try again.");
        }
    });
}

    </script>

</body>
</html>
