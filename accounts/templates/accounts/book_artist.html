{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book {{ artist.first_name }} {{ artist.last_name }}</title>

    <!-- Flatpickr for Date Selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- SweetAlert2 for Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="{% static 'css/book_artist.css' %}">
    <style>
        /* Ensure the map container is positioned relative */
        #map { height: 300px; width: 100%; position: relative; }
        #spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 50px;
            height: 50px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <a href="{% url 'home' %}">‚Üê Home</a>
    </header>

    <div class="booking-container">
        <h2>Book {{ artist.first_name }} {{ artist.last_name }}</h2>

        <form id="booking-form" method="POST" action="{% url 'book_artist' artist.id %}">
            {% csrf_token %}

            <label for="service">Select Service:</label>
            <select id="service" name="service" required>
                <option value="" disabled selected>Choose a service</option>
                {% for service in services %}
                <option 
    value="{{ service.id }}" 
    data-duration="{{ service.get_total_duration_hms }}" 
    data-workdays="{% for day in service.work_days.all %}{{ day.day }},{% endfor %}">
    {{ service.service_name }} - Rs.{{ service.price }} - {{ service.description }}
</option>


                {% endfor %}
            </select>

            <label for="duration">Duration:</label>
            <input type="text" id="duration" name="duration" readonly placeholder="Select a service first">

            <label for="date">Select Date:</label>
            <input type="text" id="date" name="date" required placeholder="Choose a date" disabled>

            <label for="start_time">Select Start Time:</label>
            <input type="time" id="start_time" name="start_time" required disabled>

            <label for="end_time">End Time:</label>
            <input type="text" id="end_time" name="end_time" readonly>

            <!-- Map Section -->
            <label for="map">Select Location:</label>
            <div id="map">
                <div id="spinner"></div>
            </div>
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">

            <label for="payment_method">Select Payment Method:</label>
            <select id="payment_method" name="payment_method" required>
                <option value="khalti">Khalti</option>
                <option value="cod">Cash on Delivery (COD)</option>
            </select>
            
            <button type="submit">Confirm Booking</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let serviceSelect = document.getElementById("service");
            let durationField = document.getElementById("duration");
            let dateInput = document.getElementById("date");
            let startTimeInput = document.getElementById("start_time");
            let endTimeInput = document.getElementById("end_time");

            let flatpickrInstance;

            // üåç Initialize Map
            var map, marker;
            function initMap(lat, lng) {
                map = L.map("map").setView([lat, lng], 13);
                var tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "¬© OpenStreetMap",
                }).addTo(map);

                tileLayer.on("load", function () {
                    document.getElementById("spinner").style.display = "none";
                });

                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                document.getElementById("latitude").value = lat;
                document.getElementById("longitude").value = lng;

                marker.on("dragend", function () {
                    var position = marker.getLatLng();
                    document.getElementById("latitude").value = position.lat.toFixed(6);
                    document.getElementById("longitude").value = position.lng.toFixed(6);
                });
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        initMap(position.coords.latitude, position.coords.longitude);
                    },
                    function () {
                        initMap(27.7172, 85.3240);
                    }
                );
            } else {
                initMap(27.7172, 85.3240);
            }

            // üéØ Enable Date & Start Time Inputs When a Service is Selected
            serviceSelect.addEventListener("change", function () {
                let selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                if (!selectedOption.value) return;

                let durationHMS = selectedOption.getAttribute("data-duration") || "00:00:00";
                let workDaysString = selectedOption.getAttribute("data-workdays") || "";
                let workDays = workDaysString.split(",").map(day => day.trim());

                // ‚úÖ Convert Work Days to JavaScript Format
                const dayMapping = { "Sunday": 0, "Monday": 1, "Tuesday": 2, "Wednesday": 3, "Thursday": 4, "Friday": 5, "Saturday": 6 };
                let allowedDays = workDays.map(day => dayMapping[day]).filter(day => day !== undefined);

                durationField.value = durationHMS;
                dateInput.disabled = false;
                startTimeInput.disabled = false;

                if (flatpickrInstance) flatpickrInstance.destroy();

                flatpickrInstance = flatpickr("#date", {
                    dateFormat: "Y-m-d",
                    enableTime: false,
                    disableMobile: true,
                    disable: [function (date) { return !allowedDays.includes(date.getDay()); }]
                });

                startTimeInput.value = "";
                endTimeInput.value = "";
            });

            // ‚è≥ Auto-calculate End Time
            startTimeInput.addEventListener("change", function () {
                let selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                if (!selectedOption.value || !startTimeInput.value) {
                    endTimeInput.value = "";
                    return;
                }

                let durationHMS = selectedOption.getAttribute("data-duration") || "00:00:00";
                let [durationHours, durationMinutes, durationSeconds] = durationHMS.split(":").map(Number);

                let durationInMinutes = (durationHours * 60) + durationMinutes + (durationSeconds / 60);
                if (durationInMinutes === 0) {
                    endTimeInput.value = "";
                    return;
                }

                let [startHours, startMinutes] = startTimeInput.value.split(":").map(Number);
                let totalMinutes = startMinutes + durationInMinutes;
                let endHours = startHours + Math.floor(totalMinutes / 60);
                let endMinutes = totalMinutes % 60;

                endTimeInput.value = `${String(endHours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
            });
        });
        
    document.addEventListener("DOMContentLoaded", function () {
        let bookingForm = document.getElementById("booking-form");

        bookingForm.addEventListener("submit", function (event) {
            event.preventDefault();  // ‚úÖ Prevent default form submission

            let formData = new FormData(bookingForm);

            fetch(bookingForm.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    // ‚ùå Show error dialog for already booked slot
                    Swal.fire({
                        title: "Time Slot Unavailable!",
                        text: data.error,
                        icon: "error",
                        confirmButtonColor: "#d33"
                    });
                } else {
                    // ‚úÖ Show success dialog for successful booking with email confirmation
                    Swal.fire({
                        title: "Booking Confirmed!",
                        text: data.success,
                        icon: "success",
                        confirmButtonColor: "#28a745"
                    }).then(() => {
                        window.location.href = "{% url 'booking_history' %}"; // Redirect to booking history
                    });
                }
            })
            .catch(error => {
                console.error("Error:", error);
                Swal.fire("Error!", "Something went wrong. Please try again.", "error");
            });
        });
    });

    </script>
</body>
</html>
