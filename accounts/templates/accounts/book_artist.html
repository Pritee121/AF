{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book {{ artist.first_name }} {{ artist.last_name }}</title>

    <!-- Flatpickr for Date Selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- SweetAlert2 for Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="{% static 'css/book_artist.css' %}">
</head>
<body>
    <header>
        <a href="{% url 'home' %}">‚Üê Home</a>
    </header>

    <div class="booking-container">
        <h2>Book {{ artist.first_name }} {{ artist.last_name }}</h2>

        <form id="booking-form" method="POST" action="{% url 'book_artist' artist.id %}">
            {% csrf_token %}

            <label for="service">Select Service:</label>
            <select id="service" name="service" required>
                <option value="" disabled selected>Choose a service</option>
                {% for service in services %}
                <!-- <option 
                    value="{{ service.id }}" 
                    data-duration="{{ service.duration }}" 
                    data-workdays="{{ service.work_days }}" 
                    data-created="{{ service.created_at }}">
                    {{ service.service_name }} - Rs.{{ service.price }} - {{ service.description }}
                </option> --><option 
    value="{{ service.id }}" 
    data-duration="{{ service.duration }}" 
    data-workdays="{{ service.work_days }}" 
    data-opening-time="{{ service.opening_time }}"
    data-closing-time="{{ service.closing_time }}"
    data-created="{{ service.created_at }}">
    {{ service.service_name }} - Rs.{{ service.price }} - {{ service.description }}
</option>

                {% endfor %}
            </select>

            <label for="duration">Duration:</label>
            <input type="text" id="duration" name="duration" readonly placeholder="Select a service first">

            <label for="date">Select Date:</label>
            <input type="text" id="date" name="date" required placeholder="Choose a date" disabled>

            <label for="start_time">Select Start Time:</label>
            <input type="time" id="start_time" name="start_time" required disabled>

            <label for="end_time">End Time:</label>
            <input type="text" id="end_time" name="end_time" readonly>

            <!-- üåç Map Section -->
            <label for="map">Select Location:</label>
            <div id="map" style="height: 300px;"></div>
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">

            <label for="payment_method">Select Payment Method:</label>
            <select id="payment_method" name="payment_method" required>
                <option value="khalti">Khalti</option>
                <option value="cod">Cash on Delivery (COD)</option>
            </select>
            
            <button type="submit">Confirm Booking</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let serviceSelect = document.getElementById("service");
            let durationField = document.getElementById("duration");
            let dateInput = document.getElementById("date");
            let startTimeInput = document.getElementById("start_time");
            let endTimeInput = document.getElementById("end_time");
            let flatpickrInstance;
            let map, marker;

            // ‚úÖ Initialize Map with Default Location
            function initMap(lat, lng) {
                map = L.map("map").setView([lat, lng], 13);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "¬© OpenStreetMap",
                }).addTo(map);

                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                document.getElementById("latitude").value = lat;
                document.getElementById("longitude").value = lng;

                marker.on("dragend", function () {
                    let position = marker.getLatLng();
                    document.getElementById("latitude").value = position.lat.toFixed(6);
                    document.getElementById("longitude").value = position.lng.toFixed(6);
                });
            }

            // ‚úÖ Get User Location
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    initMap(position.coords.latitude, position.coords.longitude);
                },
                function () {
                    initMap(27.7172, 85.3240); // Default to Kathmandu
                }
            );

            // ‚úÖ Enable Date Selection Based on Service Availability
            serviceSelect.addEventListener("change", function () {
                let selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                if (!selectedOption.value) return;

                let durationHMS = selectedOption.getAttribute("data-duration") || "00:00:00";
                let workDaysString = selectedOption.getAttribute("data-workdays") || "";
                let workDays = workDaysString.split(",").map(day => day.trim());

                let openingTime = selectedOption.dataset.openingTime || "08:00";
let closingTime = selectedOption.dataset.closingTime || "20:00";

                let createdAt = selectedOption.getAttribute("data-created") || new Date().toISOString().split("T")[0];

                const dayMapping = { "Sunday": 0, "Monday": 1, "Tuesday": 2, "Wednesday": 3, "Thursday": 4, "Friday": 5, "Saturday": 6 };
                let allowedDays = workDays.map(day => dayMapping[day]).filter(day => day !== undefined);

                durationField.value = durationHMS;
                dateInput.disabled = false;
                startTimeInput.disabled = false;

                if (flatpickrInstance) flatpickrInstance.destroy();

                flatpickrInstance = flatpickr("#date", {
                    dateFormat: "Y-m-d",
                    enableTime: false,
                    disableMobile: true,
                    minDate: createdAt,
                    disable: [date => !allowedDays.includes(date.getDay())]
                });

                startTimeInput.value = "";
                endTimeInput.value = "";
                if (openingTime && closingTime) {
    console.log("Opening Time:", openingTime, "Closing Time:", closingTime); // ‚úÖ Debugging
    startTimeInput.setAttribute("min", openingTime);
    startTimeInput.setAttribute("max", closingTime);
} else {
    console.warn("Opening/Closing times missing, using defaults!"); // ‚úÖ Debugging
    startTimeInput.setAttribute("min", "00:00");  
    startTimeInput.setAttribute("max", "23:59");  
}


            });

            startTimeInput.addEventListener("change", function () {
                let selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                if (!selectedOption.value || !startTimeInput.value) {
                    endTimeInput.value = "";
                    return;
                }

                let durationHMS = selectedOption.getAttribute("data-duration") || "00:00:00";
                let [durationHours, durationMinutes, durationSeconds] = durationHMS.split(":").map(Number);
                let durationInMinutes = (durationHours * 60) + durationMinutes + (durationSeconds / 60);

                let openingTime = selectedOption.getAttribute("data-opening-time") || "08:00";
                let closingTime = selectedOption.getAttribute("data-closing-time") || "20:00";

                let [startHours, startMinutes] = startTimeInput.value.split(":").map(Number);
                let totalMinutes = startMinutes + durationInMinutes;
                let endHours = startHours + Math.floor(totalMinutes / 60);
                let endMinutes = totalMinutes % 60;
                let endTimeString = `${String(endHours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;

                if (endTimeString > closingTime) {
                    Swal.fire({
                        title: "Invalid End Time!",
                        text: "The selected time exceeds working hours. Please choose an earlier start time.",
                        icon: "error",
                        confirmButtonColor: "#d33"
                    });
                    endTimeInput.value = "";
                } else {
                    endTimeInput.value = endTimeString;
                }
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
    let bookingForm = document.getElementById("booking-form");

    bookingForm.addEventListener("submit", function (event) {
        event.preventDefault();  // ‚úÖ Prevent default form submission
        
        console.log("üîç Form submission triggered!");  // ‚úÖ Debugging

        let formData = new FormData(bookingForm);

        console.log("üì§ Sending form data:", Object.fromEntries(formData.entries()));  // ‚úÖ Debugging

        fetch(bookingForm.action, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log("‚úÖ Server Response:", data);  // ‚úÖ Debugging
            if (data.error) {
                Swal.fire({
                    title: "Booking Error!",
                    text: data.error,
                    icon: "error",
                    confirmButtonColor: "#d33"
                });
            } else {
                Swal.fire({
                    title: "Booking Confirmed!",
                    text: data.success,
                    icon: "success",
                    confirmButtonColor: "#28a745"
                }).then(() => {
                    window.location.href = "{% url 'booking_history' %}";  // ‚úÖ Redirect after success
                });
            }
        })
        .catch(error => {
            console.error("‚ùå Error:", error);  // ‚úÖ Debugging network errors
            Swal.fire("Error!", "Something went wrong. Please try again.", "error");
        });
    });
});

    </script>
</body>
</html>
