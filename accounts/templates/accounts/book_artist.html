{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book {{ artist.first_name }} {{ artist.last_name }}</title>

    <!-- Flatpickr for Date Selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- SweetAlert2 for Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="{% static 'css/book_artist.css' %}">
</head>
<body>
    <header>
        <a href="{% url 'home' %}">‚Üê Home</a>
    </header>

    <div class="booking-container">
        <h2>Book {{ artist.first_name }} {{ artist.last_name }}</h2>

        <form id="booking-form" method="POST" action="{% url 'book_artist' artist.id %}">
            {% csrf_token %}

            <label for="service">Select Service:</label>
            <select id="service" name="service" required>
                <option value="" disabled selected>Choose a service</option>
            </select>

            <label for="date">Select Date:</label>
            <input type="text" id="date" name="date" required placeholder="Choose a date" disabled>

            <label for="schedule">Select Available Schedule:</label>
            <select id="schedule" name="schedule" required disabled>
                <option value="" disabled selected>Choose a date first</option>
            </select>

            <!-- üåç Map Section -->
            <label for="map">Select Location:</label>
            <div id="map" style="height: 300px;"></div>
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">

            <label for="payment_method">Select Payment Method:</label>
            <select id="payment_method" name="payment_method" required>
                <option value="khalti">Khalti</option>
                <option value="cod">Cash on Delivery (COD)</option>
            </select>
            
            <button type="submit">Confirm Booking</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let serviceSelect = document.getElementById("service");
            let dateInput = document.getElementById("date");
            let scheduleSelect = document.getElementById("schedule");
            let services = JSON.parse('{{ services|escapejs }}');
            let map, marker;

            // ‚úÖ Initialize Map with Default Location
            function initMap(lat, lng) {
                map = L.map("map").setView([lat, lng], 13);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "¬© OpenStreetMap",
                }).addTo(map);

                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                document.getElementById("latitude").value = lat;
                document.getElementById("longitude").value = lng;

                marker.on("dragend", function () {
                    let position = marker.getLatLng();
                    document.getElementById("latitude").value = position.lat.toFixed(6);
                    document.getElementById("longitude").value = position.lng.toFixed(6);
                });
            }

            // ‚úÖ Get User Location
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    initMap(position.coords.latitude, position.coords.longitude);
                },
                function () {
                    initMap(27.7172, 85.3240); // Default to Kathmandu
                }
            );

            // ‚úÖ Populate service dropdown
            services.forEach(service => {
                let option = new Option(service.service_name, service.id);
                option.dataset.workDays = service.work_days;
                option.dataset.schedules = JSON.stringify(service.schedules);
                serviceSelect.appendChild(option);
            });

            // ‚úÖ Handle service selection to enable date selection
            serviceSelect.addEventListener("change", function () {
                let selectedService = serviceSelect.options[serviceSelect.selectedIndex];
                let schedules = JSON.parse(selectedService.dataset.schedules);
                let workDays = selectedService.dataset.workDays.split(",");

                if (window.flatpickrInstance) {
                    window.flatpickrInstance.destroy();
                }

                // ‚úÖ Enable only valid working days in Flatpickr
                window.flatpickrInstance = flatpickr(dateInput, {
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    disable: [
                        function (date) {
                            return !workDays.includes(date.toLocaleDateString('en-US', { weekday: 'long' }));
                        }
                    ],
                    onChange: function (selectedDates) {
                        let selectedDay = selectedDates[0].toLocaleDateString('en-US', { weekday: 'long' });

                        // ‚úÖ Populate Schedule Dropdown with only available slots
                        scheduleSelect.innerHTML = '<option value="" disabled selected>Select a time slot</option>';
                        if (schedules[selectedDay]) {
                            schedules[selectedDay].forEach(slot => {
                                let option = document.createElement("option");
                                option.value = slot;
                                option.textContent = slot;
                                scheduleSelect.appendChild(option);
                            });
                        } else {
                            scheduleSelect.innerHTML = '<option value="" disabled>No available slots</option>';
                        }

                        scheduleSelect.disabled = false;
                    }
                });

                dateInput.disabled = false;
            });

            // ‚úÖ Handle form submission
            document.getElementById("booking-form").addEventListener("submit", function (event) {
                event.preventDefault();

                let formData = new FormData(this);

                fetch(this.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        Swal.fire("Booking Error!", data.error, "error");
                    } else {
                        Swal.fire("Booking Confirmed!", data.success, "success").then(() => {
                            window.location.href = "{% url 'booking_history' %}";
                        });
                    }
                })
                .catch(error => {
                    console.error("‚ùå Error:", error);
                    Swal.fire("Error!", "Something went wrong. Please try again.", "error");
                });
            });
        });
    </script>
</body>
</html>
