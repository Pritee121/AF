{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book {{ artist.first_name }} {{ artist.last_name }}</title>

    <!-- ‚úÖ Flatpickr for Date Selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- ‚úÖ SweetAlert2 for Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- ‚úÖ Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="{% static 'css/book_artist.css' %}">
    <style>#map { height: 300px; width: 100%; }</style>
    <style>
        /* üåô Dark Mode Styles */
body.dark-mode {
    background-color: #121212;
    color: #ffffff;
}

/* ‚úÖ Update other elements for dark mode */
.dark-mode .header,
.dark-mode .navbar {
    background-color: #222;
}

.dark-mode .nav-link {
    color: white;
}

.dark-mode .search-form {
    background: #333;
    box-shadow: 0px 4px 6px rgba(255, 255, 255, 0.1);
}

.dark-mode input,
.dark-mode textarea,
.dark-mode select {
    background-color: #222;
    color: white;
    border: 1px solid #555;
}

.dark-mode .book-btn {
    background-color: #D8648C;
    color: white;
}

.dark-mode .book-btn:hover {
    background-color: #b24d70;
}

.dark-mode .artist-container {
    background-color: #1a1a1a;
}

/* ‚úÖ Toggle Switch */
#dark-mode-toggle {
    position: fixed;
    top: 10px;
    right: 20px;
    background: #222;
    color: white;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 5px;
}

.dark-mode #dark-mode-toggle {
    background: #f8f9fa;
    color: #222;
}

    </style>
</head>
<body>
    <header>
        <a href="{% url 'home' %}">‚Üê Home</a>
    </header>

    <div class="booking-container">
        <h2>Book {{ artist.first_name }} {{ artist.last_name }}</h2>

        <form id="booking-form" method="POST" action="{% url 'book_artist' artist.id %}">
            {% csrf_token %}

            <!-- ‚úÖ Service Selection -->
            <label for="service">Select Service:</label>
            <select id="service" name="service" required>
                <option value="" disabled selected>Choose a service</option>
                {% for service in services %}
                    <option value="{{ service.id }}" data-duration="{{ service.duration }}">
                        {{ service.service_name }} - Rs.{{ service.price }}
                    </option>
                {% endfor %}
            </select>

            <!-- ‚úÖ Duration Display (Auto-updating) -->
            <label for="duration">Duration:</label>
            <input type="text" id="duration" name="duration" readonly placeholder="Select a service first">

            <!-- ‚úÖ Date Selection -->
            <label for="date">Select Date:</label>
            <input type="text" id="date" name="date" required placeholder="Choose a date" disabled>

            <!-- ‚úÖ Time Selection -->
            <label for="time">Select Time:</label>
            <select id="time" name="time" required disabled>
                <option value="" disabled selected>Select time</option>
            </select>

            <!-- ‚úÖ Location Selection -->
            <label for="map">Select Location:</label>
            <div id="map"></div>
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">

            <!-- ‚úÖ Payment Selection -->
            <label for="payment_method">Select Payment Method:</label>
            <select id="payment_method" name="payment_method" required>
                <option value="khalti">Khalti</option>
                <option value="cod">Cash on Delivery (COD)</option>
            </select>
            
            <button type="submit">Confirm Booking</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let serviceSelect = document.getElementById("service");
            let durationField = document.getElementById("duration");
            let dateInput = document.getElementById("date");
            let timeInput = document.getElementById("time");
            let bookingForm = document.getElementById("booking-form");

            // ‚úÖ Update Duration When Service is Selected
            serviceSelect.addEventListener("change", function () {
                let selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                let duration = selectedOption.getAttribute("data-duration");

                if (duration) {
                    durationField.value = duration; // ‚úÖ Auto-fill duration
                } else {
                    durationField.value = ""; // ‚úÖ Reset if no service selected
                }

                // ‚úÖ Reset and fetch available dates
                dateInput.value = "";
                timeInput.innerHTML = "<option value='' disabled selected>Select time</option>";
                timeInput.disabled = true;
                if (serviceSelect.value) {
                    fetchAvailableDates(serviceSelect.value);
                }
            });

            // ‚úÖ Fetch Available Dates for Selected Service
            function fetchAvailableDates(serviceId) {
                fetch(`/get-available-dates/{{ artist.id }}/?service_id=${serviceId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.available_dates.length === 0) {
                            Swal.fire("No Available Dates", "Please choose another service.", "info");
                            dateInput.disabled = true;
                        } else {
                            dateInput.disabled = false;
                            flatpickr("#date", {
                                dateFormat: "Y-m-d",
                                enableTime: false,
                                disableMobile: true,
                                enable: data.available_dates  // ‚úÖ Show only available dates
                            });
                        }
                    })
                    .catch(error => console.error("Error fetching available dates:", error));
            }

            // ‚úÖ Fetch Available Times for Selected Date & Service
            function fetchAvailableTimes(serviceId, date) {
                fetch(`/get-available-times/{{ artist.id }}/?service_id=${serviceId}&date=${date}`)
                    .then(response => response.json())
                    .then(data => {
                        timeInput.innerHTML = "<option value='' disabled selected>Choose a time</option>";
                        if (data.available_times.length === 0) {
                            Swal.fire("No Available Slots", "Please choose another date.", "info");
                            timeInput.disabled = true;
                        } else {
                            timeInput.disabled = false;
                            data.available_times.forEach(time => {
                                let option = document.createElement("option");
                                option.value = time;
                                option.textContent = time;
                                timeInput.appendChild(option);
                            });
                        }
                    })
                    .catch(error => console.error("Error fetching available times:", error));
            }

            // ‚úÖ Fetch Available Times When Date is Selected
            dateInput.addEventListener("change", function () {
                let selectedServiceId = serviceSelect.value;
                let selectedDate = dateInput.value;
                if (selectedServiceId && selectedDate) {
                    fetchAvailableTimes(selectedServiceId, selectedDate);
                }
            });

            // ‚úÖ Leaflet.js for Location Selection
            var map = L.map('map').setView([27.7172, 85.3240], 13); // Default to Kathmandu
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            var marker = L.marker([27.7172, 85.3240], { draggable: true }).addTo(map);

            // ‚úÖ Get User's Current Location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var userLat = position.coords.latitude;
                    var userLng = position.coords.longitude;
                    var userLocation = new L.LatLng(userLat, userLng);
                    map.setView(userLocation, 13);
                    marker.setLatLng(userLocation);
                    document.getElementById("latitude").value = userLat;
                    document.getElementById("longitude").value = userLng;
                });
            }

            // ‚úÖ Update Lat & Lng on Marker Drag
            marker.on('dragend', function(event) {
                var position = marker.getLatLng();
                document.getElementById("latitude").value = position.lat.toFixed(6);
                document.getElementById("longitude").value = position.lng.toFixed(6);
            });

            // ‚úÖ Handle Form Submission with AJAX
            bookingForm.addEventListener("submit", function(event) {
                event.preventDefault();  // ‚úÖ Prevent default form submission

                let formData = new FormData(bookingForm);

                fetch(bookingForm.action, {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        Swal.fire("Booking Confirmed!", "You will receive a confirmation soon.", "success")
                        .then(() => window.location.href = "{% url 'home' %}");
                    } else {
                        Swal.fire("Booking Failed", data.message || "Try again.", "error");
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        });
        
document.addEventListener("DOMContentLoaded", function () {
    const darkModeToggle = document.getElementById("dark-mode-toggle");
    const body = document.body;

    // ‚úÖ Check if dark mode is enabled in localStorage
    if (localStorage.getItem("darkMode") === "enabled") {
        body.classList.add("dark-mode");
        darkModeToggle.textContent = "‚òÄ Light Mode";
    }

    // ‚úÖ Toggle Dark Mode
    darkModeToggle.addEventListener("click", function () {
        body.classList.toggle("dark-mode");

        // ‚úÖ Save the preference in localStorage
        if (body.classList.contains("dark-mode")) {
            localStorage.setItem("darkMode", "enabled");
            darkModeToggle.textContent = "‚òÄ Light Mode";
        } else {
            localStorage.setItem("darkMode", "disabled");
            darkModeToggle.textContent = "üåô Dark Mode";
        }
    });
});


    </script>
</body>
</html>
