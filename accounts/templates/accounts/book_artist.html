{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book {{ artist.first_name }} {{ artist.last_name }}</title>

    <!-- ✅ Flatpickr for Date Selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- ✅ SweetAlert2 for Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- ✅ Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="{% static 'css/book_artist.css' %}">
    <style>#map { height: 300px; width: 100%; }</style>
</head>
<body>
    <header>
        <a href="{% url 'home' %}">← Home</a>
    </header>

    <div class="booking-container">
        <h2>Book {{ artist.first_name }} {{ artist.last_name }}</h2>

        <form id="booking-form" method="POST" action="{% url 'book_artist' artist.id %}">
            {% csrf_token %}

            <label for="service">Select Service:</label>
            <select id="service" name="service" required>
                <option value="" disabled selected>Choose a service</option>
                {% for service in services %}
                    <option value="{{ service.id }}" data-duration="{{ service.duration }}">
                        {{ service.service_name }} - Rs.{{ service.price }} - {{service.description}}
                    </option>
                {% endfor %}
            </select>

            <label for="duration">Duration:</label>
            <input type="text" id="duration" name="duration" readonly placeholder="Select a service first">

            <label for="date">Select Date:</label>
            <input type="text" id="date" name="date" required placeholder="Choose a date" disabled>

            <label for="time">Select Time:</label>
            <select id="time" name="time" required disabled>
                <option value="" disabled selected>Select time</option>
            </select>

            <label for="map">Select Location:</label>
            <div id="map"></div>
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">

            <label for="payment_method">Select Payment Method:</label>
            <select id="payment_method" name="payment_method" required>
                <option value="khalti">Khalti</option>
                <option value="cod">Cash on Delivery (COD)</option>
            </select>
            
            <button type="submit">Confirm Booking</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let serviceSelect = document.getElementById("service");
            let durationField = document.getElementById("duration");
            let dateInput = document.getElementById("date");
            let timeInput = document.getElementById("time");
            let bookingForm = document.getElementById("booking-form");

            var map, marker;

            // ✅ Function to Initialize Map
            function initMap(lat, lng) {
                map = L.map('map').setView([lat, lng], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                marker = L.marker([lat, lng], { draggable: true }).addTo(map);

                // ✅ Update Input Fields
                document.getElementById("latitude").value = lat;
                document.getElementById("longitude").value = lng;

                // ✅ Update Coordinates on Drag
                marker.on('dragend', function () {
                    var position = marker.getLatLng();
                    document.getElementById("latitude").value = position.lat.toFixed(6);
                    document.getElementById("longitude").value = position.lng.toFixed(6);
                });
            }

            // ✅ Try Getting User's Current Location Immediately
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        var userLat = position.coords.latitude;
                        var userLng = position.coords.longitude;
                        initMap(userLat, userLng); // ✅ Load map at user's actual location
                    },
                    function (error) {
                        console.error("Geolocation Error:", error);
                        alert("Location access denied. Using default location.");
                        initMap(27.7172, 85.3240); // ✅ Kathmandu as fallback
                    }
                );
            } else {
                alert("Geolocation not supported by this browser.");
                initMap(27.7172, 85.3240); // ✅ Kathmandu as fallback
            }

            // ✅ Service Duration Auto-Update
            serviceSelect.addEventListener("change", function () {
                let selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                let duration = selectedOption.getAttribute("data-duration");

                if (duration) {
                    durationField.value = duration;
                } else {
                    durationField.value = "";
                }

                dateInput.value = "";
                timeInput.innerHTML = "<option value='' disabled selected>Select time</option>";
                timeInput.disabled = true;

                if (serviceSelect.value) {
                    fetchAvailableDates(serviceSelect.value);
                }
            });

            // ✅ Fetch Available Dates
            function fetchAvailableDates(serviceId) {
                fetch(`/get-available-dates/{{ artist.id }}/?service_id=${serviceId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.available_dates.length === 0) {
                            Swal.fire("No Available Dates", "Please choose another service.", "info");
                            dateInput.disabled = true;
                        } else {
                            dateInput.disabled = false;
                            flatpickr("#date", {
                                dateFormat: "Y-m-d",
                                enableTime: false,
                                disableMobile: true,
                                enable: data.available_dates
                            });
                        }
                    })
                    .catch(error => console.error("Error fetching available dates:", error));
            }

            // ✅ Fetch Available Times
            function fetchAvailableTimes(serviceId, date) {
                fetch(`/get-available-times/{{ artist.id }}/?service_id=${serviceId}&date=${date}`)
                    .then(response => response.json())
                    .then(data => {
                        timeInput.innerHTML = "<option value='' disabled selected>Choose a time</option>";
                        if (data.available_times.length === 0) {
                            Swal.fire("No Available Slots", "Please choose another date.", "info");
                            timeInput.disabled = true;
                        } else {
                            timeInput.disabled = false;
                            data.available_times.forEach(time => {
                                let option = document.createElement("option");
                                option.value = time;
                                option.textContent = time;
                                timeInput.appendChild(option);
                            });
                        }
                    })
                    .catch(error => console.error("Error fetching available times:", error));
            }

            dateInput.addEventListener("change", function () {
                let selectedServiceId = serviceSelect.value;
                let selectedDate = dateInput.value;
                if (selectedServiceId && selectedDate) {
                    fetchAvailableTimes(selectedServiceId, selectedDate);
                }
            });

            // ✅ Success Message on Form Submission
            bookingForm.addEventListener("submit", function (event) {
                event.preventDefault();

                let formData = new FormData(bookingForm);
                fetch(bookingForm.action, {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        Swal.fire("Your booking has been listed!", "You will receive a confirmation soon.", "success")
                        .then(() => window.location.href = "{% url 'home' %}");
                    } else {
                        Swal.fire("Booking Failed", data.message || "Try again.", "error");
                    }
                })
                .catch(error => console.error("Error:", error));
            });

        });
    </script>
</body>
</html>
