{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings</title>
    <link rel="stylesheet" href="{% static 'css/bookings2.css' %}">
</head>
<body>
    <header>
        <a href="{% url 'artist_dashboard' %}">← Back to Home</a>
    </header>

    <div class="bookings-container">
        <h2>My Bookings</h2>

        {% if user_bookings %}
            <table>
                <thead>
                    <tr>
                        <th>Artist</th>
                        <th>Client</th>
                        <th>Service</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Payment</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in user_bookings %}
                    <tr>
                        <td>{{ booking.artist.first_name }} {{ booking.artist.last_name }}</td>
                        <td>{{ booking.client.first_name }} {{ booking.client.last_name }}</td>
                        <td>{{ booking.service.service_name }} - ${{ booking.service.price }}</td>
                        <td>{{ booking.date }}</td>
                        <td>{{ booking.time }}</td>
                        <td>{{ booking.payment_method|title }}</td>
                        <td>{{ booking.service.duration }}</td>
                        <td id="status-{{ booking.id }}">{{ booking.status }}</td> <!-- ✅ Show Status -->
                        <td>
                            {% if booking.status == "Pending" %}
                                <button onclick="updateBookingStatus({{ booking.id }}, 'Confirmed')">Confirm</button>
                                <button onclick="updateBookingStatus({{ booking.id }}, 'Cancelled')">Cancel</button>
                            {% else %}
                                {{ booking.status }} <!-- ✅ Show status if already updated -->
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No bookings found.</p>  <!-- ✅ Show message if there are no bookings -->
        {% endif %}  <!-- ✅ Properly close the 'if' statement -->

      
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

      
        <script>
            function updateBookingStatus(bookingId, status) {
                Swal.fire({
                    title: `Are you sure?`,
                    text: `Do you want to ${status.toLowerCase()} this booking?`,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Yes, proceed!",
                    cancelButtonText: "No, cancel"
                }).then((result) => {
                    if (!result.isConfirmed) {
                        return; // ✅ If user cancels, do nothing
                    }
        
                    // ✅ Proceed with status update
                    fetch(`/update-booking-status/${bookingId}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ status: status })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // ✅ Update status dynamically in table
                            document.getElementById(`status-${bookingId}`).innerText = data.status;
        
                            // ✅ Show success notification
                            Swal.fire({
                                title: "Success!",
                                text: data.message + " A confirmation email has been sent.",
                                icon: "success",
                                confirmButtonText: "OK"
                            });
        
                        } else {
                            Swal.fire({
                                title: "Error!",
                                text: data.error || "Could not update booking. Try again later.",
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        Swal.fire({
                            title: "Error!",
                            text: "Something went wrong! Please try again later.",
                            icon: "error"
                        });
                    });
                });
            }
        </script>
        
    </div>
</body>
</html>
