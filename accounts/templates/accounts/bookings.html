{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings</title>

    <!-- Load CSS -->
    <link rel="stylesheet" href="{% static 'css/bookings2.css' %}">

    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- SweetAlert2 for Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Optional styling if you want to keep a map container here */
        #map-container {
            margin-top: 20px;
            width: 100%;
            text-align: center;
        }
        #map {
            height: 400px;
            width: 80%;
            margin: auto;
        }
        .footer {
            background: rgba(216, 100, 140, 0.2);
            color: #D8648C;
            text-align: center;
            padding: 15px;
            margin-top: auto;
            border-top: 2px solid #D8648C;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <header>
        <a href="{% url 'artist_dashboard' %}">‚Üê Back to Home</a>
    </header>

    <div class="bookings-container">
        <h2>My Bookings</h2>

        {% if user_bookings %}
            <table>
                <thead>
                    <tr>
                        <th>Artist</th>
                        <th>Client</th>
                        <th>Service</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Payment</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in user_bookings %}
                    <tr>
                        <td>{{ booking.artist.first_name }} {{ booking.artist.last_name }}</td>
                        <td>{{ booking.client.first_name }} {{ booking.client.last_name }}</td>
                        <td>{{ booking.service.service_name }} - Rs.{{ booking.service.price }}</td>
                        <td>{{ booking.date }}</td>
                        <td>{{ booking.time }}</td>
                        <td>{{ booking.payment_method|title }}</td>
                        <td>{{ booking.service.duration }}</td>
                        <td id="status-{{ booking.id }}">{{ booking.status }}</td>
                        <td>
                            {% if booking.status == "Pending" %}
                                <button onclick="updateBookingStatus({{ booking.id }}, 'Confirmed')">Confirm</button>
                                <button onclick="updateBookingStatus({{ booking.id }}, 'Cancelled')">Cancel</button>
                            {% else %}
                                {{ booking.status }}
                            {% endif %}
                            <!-- Open map in new page -->
                            <button onclick="viewLocation({{ booking.latitude }}, {{ booking.longitude }})">üìç View Location</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No bookings found.</p>
        {% endif %}
    </div>

    <footer class="footer">
        <p>Artist Finder &copy; All rights reserved</p>
    </footer>

    <script>
        // Open the booking location on a new page
        function viewLocation(lat, lng) {
            if (!lat || !lng) {
                Swal.fire("Location Not Available", "This booking does not have a saved location.", "info");
                return;
            }
            const mapUrl = `/booking-location/?lat=${lat}&lng=${lng}`;
            window.open(mapUrl, '_blank');
        }

        // Function to update the booking status using fetch API and SweetAlert2
        function updateBookingStatus(bookingId, status) {
            Swal.fire({
                title: `Are you sure?`,
                text: `Do you want to ${status.toLowerCase()} this booking?`,
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, proceed!",
                cancelButtonText: "No, cancel"
            }).then((result) => {
                if (!result.isConfirmed) {
                    return;
                }
                fetch(`/update-booking-status/${bookingId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ status: status })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: "Success!",
                            text: data.message + " A confirmation email has been sent.",
                            icon: "success",
                            confirmButtonText: "OK"
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: "Error!",
                            text: data.error || "Could not update booking. Try again later.",
                            icon: "error"
                        });
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    Swal.fire({
                        title: "Error!",
                        text: "Something went wrong! Please try again later.",
                        icon: "error"
                    });
                });
            });
        }
    </script>
</body>
</html>
